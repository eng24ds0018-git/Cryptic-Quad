        
        <!-- Mode Selection Screen -->
        <div id="modeSelectionScreen" class="hidden screen">
            <h2 class="text-3xl font-bold text-center text-white mb-8">Choose Game Mode</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 max-w-2xl mx-auto">
                <div class="relative">
                    <button id="singlePlayerButton" class="btn-primary text-white font-bold py-6 px-8 rounded-xl focus:outline-none focus:ring-4 focus:ring-purple-300 w-full text-lg">
                        üéØ Single Player
                        <p class="text-sm text-white text-opacity-80 mt-1">Play against the computer</p>
                    </button>
                </div>
                <div class="relative">
                    <button id="twoPlayerButton" class="btn-success text-white font-bold py-6 px-8 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-300 w-full text-lg">
                        üë• Two Player
                        <p class="text-sm text-white text-opacity-80 mt-1">Play with a friend locally</p>
                    </button>
                </div>
            </div>
            <div class="flex justify-center mt-10">
                <button id="howToPlayButton" class="btn-secondary text-white font-semibold py-3 px-8 rounded-lg focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all duration-300">
                    üìñ How to Play
                </button>
            </div>
        </div>

        <!-- Difficulty Selection Screen -->
        <div id="difficultySelectionScreen" class="hidden screen text-center">
            <h2 class="text-3xl font-bold text-white mb-8">Select Difficulty</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 max-w-4xl mx-auto">
                <div class="relative">
                    <button data-difficulty="beginner" class="difficulty-btn btn-success text-white font-bold py-6 px-6 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-300 w-full">
                        <div class="text-2xl mb-2">üå±</div>
                        <div class="text-lg font-bold">Beginner</div>
                        <p class="text-sm text-white text-opacity-80 mt-2">Common 4-letter words</p>
                    </button>
                </div>
                <div class="relative">
                    <button data-difficulty="intermediate" class="difficulty-btn btn-warning text-white font-bold py-6 px-6 rounded-xl focus:outline-none focus:ring-4 focus:ring-yellow-300 w-full">
                        <div class="text-2xl mb-2">üî•</div>
                        <div class="text-lg font-bold">Intermediate</div>
                        <p class="text-sm text-white text-opacity-80 mt-2">More challenging words</p>
                    </button>
                </div>
                <div class="relative">
                    <button data-difficulty="pro" class="difficulty-btn btn-danger text-white font-bold py-6 px-6 rounded-xl focus:outline-none focus:ring-4 focus:ring-red-300 w-full">
                        <div class="text-2xl mb-2">üíÄ</div>
                        <div class="text-lg font-bold">Pro</div>
                        <p class="text-sm text-white text-opacity-80 mt-2">Expert level words</p>
                    </button>
                </div>
            </div>
            <button id="backToMenuFromDiff" class="mt-10 text-lg font-semibold text-white text-opacity-70 hover:text-opacity-100 transition-all">‚Üê Back to Main Menu</button>
        </div>

        <!-- How to Play Screen -->
        <div id="howToPlayScreen" class="hidden screen">
            <h2 class="text-3xl font-bold text-center text-white mb-8">How to Play</h2>
            <div class="max-w-4xl mx-auto bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-2xl p-8 text-white">
                <div class="space-y-6">
                    <p class="text-lg text-white text-opacity-90">Cryptic Quad is a code-breaking game where you guess a secret 4-letter word.</p>
                    
                    <div class="bg-white bg-opacity-5 rounded-xl p-6">
                        <h3 class="font-bold text-xl mb-4 text-center">Game Rules</h3>
                        <ul class="space-y-3 text-white text-opacity-80">
                            <li class="flex items-start gap-3">
                                <span class="text-green-400 text-xl">‚úì</span>
                                <span>The word has <strong>no repeating consecutive letters</strong> (e.g., 'tree' is invalid, but 'pump' is valid)</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-blue-400 text-xl">‚Ñπ</span>
                                <span>You get feedback on your guess in the form of "Cows" and "Bulls"</span>
                            </li>
                        </ul>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-green-500 bg-opacity-20 rounded-xl p-6 border border-green-400 border-opacity-30">
                            <h4 class="font-bold text-lg mb-3 text-green-300">üêÆ Cow</h4>
                            <p class="text-white text-opacity-80">A correct letter in the correct position</p>
                        </div>
                        <div class="bg-yellow-500 bg-opacity-20 rounded-xl p-6 border border-yellow-400 border-opacity-30">
                            <h4 class="font-bold text-lg mb-3 text-yellow-300">üêÉ Bull</h4>
                            <p class="text-white text-opacity-80">A correct letter but in the wrong position</p>
                        </div>
                    </div>

                    <div class="bg-purple-500 bg-opacity-20 rounded-xl p-6 border border-purple-400 border-opacity-30">
                        <h4 class="font-bold text-lg mb-4 text-purple-300">Example</h4>
                        <p class="mb-2">Secret word: <span class="font-mono bg-white bg-opacity-20 px-2 py-1 rounded">WORD</span></p>
                        <p class="mb-2">Your guess: <span class="font-mono bg-white bg-opacity-20 px-2 py-1 rounded">WORK</span></p>
                        <p class="text-green-300 font-semibold">Result: 3 Cows, 0 Bulls (W, O, R are correct and in position)</p>
                    </div>

                    <p class="text-center text-lg text-white text-opacity-90">Keep guessing until you get 4 Cows! Good luck!</p>
                </div>
            </div>
            <div class="text-center mt-8">
                <button id="backToMenuFromHelp" class="btn-primary text-white font-bold py-3 px-8 rounded-xl focus:outline-none focus:ring-4 focus:ring-purple-300">Got it!</button>
            </div>
        </div>

        <!-- Set Word Screen -->
        <div id="setWordScreen" class="hidden screen text-center">
            <h2 id="setWordTitle" class="text-3xl font-bold text-white mb-4">Set the Secret Word</h2>
            <p id="setWordSubtitle" class="text-white text-opacity-70 mb-8 text-lg">Enter a 4-letter word for the other player to guess.</p>
            <div id="setWordMessageArea" class="text-center min-h-12 mb-6 font-semibold text-lg hidden items-center justify-center p-4 rounded-xl"></div>
            
            <div class="max-w-md mx-auto">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="password" id="secretWordInput" maxlength="4" placeholder="Enter secret word..."
                           class="enhanced-input flex-grow px-6 py-4 text-xl text-white placeholder-white placeholder-opacity-50 rounded-xl focus:outline-none transition-all duration-300 text-center font-mono tracking-widest">
                    <button id="startGameButton"
                            class="btn-success text-white font-bold py-4 px-8 rounded-xl focus:outline-none focus:ring-4 focus:ring-green-300 whitespace-nowrap">
                        Start Game
                    </button>
                </div>
            </div>
            
            <button id="backToMenuFromSet" class="mt-10 text-lg font-semibold text-white text-opacity-70 hover:text-opacity-100 transition-all">‚Üê Back to Menu</button>
        </div>
        
        <!-- Main Game Screen -->
        <div id="gameScreen" class="hidden screen">
            <!-- Enhanced Score Display -->
            <div id="scoreDisplay" class="hidden text-center mb-6">
                <div class="score-panel p-6 rounded-2xl">
                    <div class="flex justify-between items-center text-xl text-white font-bold">
                        <span id="player1Name" class="bg-white bg-opacity-10 px-4 py-2 rounded-lg">Player 1</span>
                        <div class="text-3xl font-extrabold">
                            <span id="player1Score" class="text-green-400">0</span>
                            <span class="text-white text-opacity-50 mx-3">-</span>
                            <span id="player2Score" class="text-blue-400">0</span>
                        </div>
                        <span id="player2Name" class="bg-white bg-opacity-10 px-4 py-2 rounded-lg">Player 2</span>
                    </div>
                    <p id="scoreToBeatDisplay" class="text-white text-opacity-70 mt-3 text-sm font-medium hidden"></p>
                    <div id="timerDisplay" class="text-white text-opacity-70 mt-3 text-sm font-medium hidden">
                        Time: <span id="timer" class="font-mono bg-white bg-opacity-20 px-2 py-1 rounded">0s</span>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col lg:flex-row lg:gap-8">
                <!-- Enhanced Left Panel: Game Controls -->
                <div class="w-full lg:w-2/3">
                    <div id="guessControls" class="mb-8">
                        <div class="flex flex-col sm:flex-row gap-4 max-w-2xl mx-auto">
                            <input type="text" id="guessInput" maxlength="4" placeholder="Enter your guess..."
                                   class="enhanced-input flex-grow px-6 py-4 text-2xl text-white placeholder-white placeholder-opacity-50 rounded-xl focus:outline-none transition-all duration-300 text-center font-mono tracking-widest uppercase">
                            <button id="guessButton"
                                    class="btn-primary text-white font-bold py-4 px-8 rounded-xl focus:outline-none focus:ring-4 focus:ring-purple-300 whitespace-nowrap text-lg">
                                üéØ Guess
                            </button>
                        </div>
                    </div>
                    
                    <div id="gameControls" class="flex justify-center mb-8">
                        <button id="quitButton"
                                class="btn-danger text-white font-bold py-3 px-6 rounded-xl focus:outline-none focus:ring-4 focus:ring-red-300 transition-all duration-300">
                            üè≥Ô∏è Quit & Reveal
                        </button>
                    </div>

                    <div id="messageArea" class="text-center min-h-12 mb-6 font-semibold text-lg flex items-center justify-center p-4 rounded-xl"></div>

                    <!-- Enhanced Rematch Request Area -->
                    <div id="rematchRequestArea" class="hidden text-center p-6 bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-2xl border border-white border-opacity-20">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Enhanced Right Panel: Guess History -->
                <div class="w-full lg:w-1/3 mt-8 lg:mt-0">
                    <div class="bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden border border-white border-opacity-20">
                        <div class="history-header grid grid-cols-4 gap-2 text-center font-bold text-white p-4">
                            <div class="text-sm">#</div>
                            <div class="text-sm">Guess</div>
                            <div class="text-sm">Cows üêÆ</div>
                            <div class="text-sm">Bulls üêÉ</div>
                        </div>
                        <div id="guessHistory" class="max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cryptic Quad Game</title>
    <!-- CRAZYGAMES SDK SCRIPT -->
    <script src="https://sdk.crazygames.com/crazygames-sdk-v2.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* Prevent mobile text selection and zoom */
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            transition: all 0.3s ease;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .dark body {
            background: linear-gradient(135deg, #2d1b69 0%, #11051f 100%);
        }
        
        .hidden { display: none; }

        /* Enhanced glassmorphism effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Button press animation */
        button:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        /* Screen transitions */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .screen {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Guess history styling */
        .history-row:nth-child(even) { background-color: rgba(248, 250, 252, 0.7); }
        .history-row:nth-child(odd) { background-color: rgba(255, 255, 255, 0.7); }
        .dark .history-row:nth-child(even) { background-color: rgba(51, 65, 85, 0.5); }
        .dark .history-row:nth-child(odd) { background-color: rgba(30, 41, 59, 0.5); }

        /* Message styles */
        .message-success { background-color: rgba(220, 252, 231, 0.8); color: #166534; }
        .dark .message-success { background-color: rgba(20, 83, 45, 0.8); color: #bbf7d0; }
        .message-error { background-color: rgba(254, 226, 226, 0.8); color: #991b1b; }
        .dark .message-error { background-color: rgba(127, 29, 29, 0.8); color: #fecaca; }
        .message-info { background-color: rgba(224, 231, 255, 0.8); color: #3730a3; }
        .dark .message-info { background-color: rgba(49, 46, 129, 0.8); color: #c7d2fe; }

        /* Confetti animation */
        #confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 100; }
        .confetti { position: absolute; width: 10px; height: 10px; opacity: 0; }
        @keyframes fall {
            from { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Responsive design improvements */
        @media (max-width: 768px) {
            .glass-panel { padding: 1rem; margin: 0.5rem; }
            .text-6xl { font-size: 2.5rem; }
            .text-5xl { font-size: 2rem; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen p-2 transition-all duration-300">
    
    <div class="w-full max-w-4xl mx-auto glass-panel rounded-2xl shadow-2xl p-4 md:p-8 transition-all duration-300 relative overflow-y-auto max-h-screen">
        <div id="confetti-container"></div>
        
        <!-- Developer watermark -->
        <div class="absolute top-4 left-4 text-left">
            <p class="text-xs text-gray-600 dark:text-gray-400 font-semibold">Developed by: Synergy Tech.</p>
        </div>

        <header class="text-center mb-8">
            <h1 class="font-bold text-5xl md:text-6xl bg-gradient-to-r from-purple-600 to-blue-600 dark:from-purple-400 dark:to-blue-400 bg-clip-text text-transparent pb-2">Cryptic Quad</h1>
            <div id="subheadingContainer">
                <p class="text-gray-500 dark:text-gray-400 mt-2 text-lg">Analyze ‚Ä¢ Guess ‚Ä¢ Enjoy</p>
                <p class="text-gray-600 dark:text-gray-500 mt-1">A 4-letter word guessing game.</p>
            </div>
            <p id="gameStatus" class="text-gray-500 dark:text-gray-400 mt-2 hidden"></p>
            
            <!-- Controls -->
            <div class="absolute top-4 right-4 flex items-center gap-1 bg-gray-200 dark:bg-gray-700 bg-opacity-50 p-1 rounded-full">
                <button id="muteButton" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-600 hover:bg-opacity-50 transition-colors">
                    <svg id="unmuteIcon" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                    <svg id="muteIcon" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l-4-4m0 4l4-4" /></svg>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-600 hover:bg-opacity-50 transition-colors">
                    <svg id="theme-icon-light" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Message Area -->
        <div id="mainMessageArea" class="text-center min-h-10 mb-4 font-medium text-lg hidden items-center justify-center p-2 rounded-lg"></div>

        <!-- Start Screen -->
        <div id="startScreen" class="screen text-center">
            <div class="mt-16 mb-16">
                <button id="startButton" class="bg-gradient-to-br from-green-500 to-green-600 text-white font-bold py-4 px-10 rounded-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-green-300 dark:focus:ring-green-800 transform transition-all duration-200 hover:scale-105 shadow-lg text-2xl">
                    START GAME
                </button>
            </div>
        </div>
        
        <!-- Mode Selection Screen -->
        <div id="modeSelectionScreen" class="hidden screen">
            <h2 class="text-2xl font-bold text-center text-gray-700 dark:text-gray-200 mb-6">Choose Game Mode</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-md mx-auto">
                <button id="singlePlayerButton" class="bg-gradient-to-br from-purple-600 to-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-blue-700 focus:outline-none focus:ring-4 focus:ring-purple-300 dark:focus:ring-purple-800 transform transition-all duration-200 hover:scale-105 shadow-lg">
                    Single Player
                </button>
                <button id="twoPlayerButton" class="bg-gradient-to-br from-green-600 to-green-700 text-white font-bold py-3 px-6 rounded-lg hover:from-green-700 hover:to-green-800 focus:outline-none focus:ring-4 focus:ring-green-300 dark:focus:ring-green-800 transform transition-all duration-200 hover:scale-105 shadow-lg">
                    Two Player
                </button>
            </div>
            <div class="flex justify-center gap-4 mt-8">
                <button id="howToPlayButton" class="bg-gray-500 bg-opacity-80 dark:bg-gray-600 dark:bg-opacity-80 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-500 transition-colors duration-300 shadow-md">
                    How to Play
                </button>
            </div>
        </div>

        <!-- Difficulty Selection Screen -->
        <div id="difficultySelectionScreen" class="hidden screen text-center">
            <h2 class="text-2xl font-bold text-center text-gray-700 dark:text-gray-200 mb-6">Select Difficulty</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <button data-difficulty="beginner" class="difficulty-btn bg-gradient-to-br from-green-500 to-green-600 text-white font-bold py-3 px-6 rounded-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-green-300 dark:focus:ring-green-800 transform transition-all duration-200 hover:scale-105 shadow-lg">
                    Beginner
                </button>
                <button data-difficulty="intermediate" class="difficulty-btn bg-gradient-to-br from-yellow-500 to-yellow-600 text-white font-bold py-3 px-6 rounded-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-yellow-300 dark:focus:ring-yellow-800 transform transition-all duration-200 hover:scale-105 shadow-lg">
                    Intermediate
                </button>
                <button data-difficulty="pro" class="difficulty-btn bg-gradient-to-br from-red-500 to-red-600 text-white font-bold py-3 px-6 rounded-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-800 transform transition-all duration-200 hover:scale-105 shadow-lg">
                    Pro
                </button>
            </div>
            <button id="backToMenuFromDiff" class="mt-8 text-sm font-semibold text-blue-600 dark:text-blue-400 hover:underline">Back to Main Menu</button>
        </div>

        <!-- How to Play Screen -->
        <div id="howToPlayScreen" class="hidden screen max-w-none">
            <h2 class="text-2xl font-bold text-center text-gray-700 dark:text-gray-200 mb-6">How to Play</h2>
            <div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300">
                <p>Cryptic Quad is a code-breaking game where you guess a secret 4-letter word.</p>
                <ul class="list-disc ml-6">
                    <li>The word has <strong>no repeating consecutive letters</strong> (e.g., 'tree' is invalid, but 'pump' is valid).</li>
                    <li>You get feedback on your guess in the form of "Cows" and "Bulls".</li>
                </ul>
                <h3 class="font-semibold mt-4">What are Cows and Bulls?</h3>
                <p><strong>üêÆ Cow:</strong> A correct letter in the correct position.</p>
                <p><strong>üêÉ Bull:</strong> A correct letter but in the wrong position.</p>
                <h3 class="font-semibold mt-4">Example</h3>
                <p>Secret word: <strong>WORD</strong></p>
                <div class="bg-gray-100 dark:bg-gray-700 bg-opacity-50 p-4 rounded-lg my-4">
                    <p>You guess: <strong>WORK</strong></p>
                    <p><strong>Result:</strong> 3 Cows, 0 Bulls (W, O, R are correct and in position)</p>
                </div>
                <p>Keep guessing until you get 4 Cows! Good luck!</p>
            </div>
            <div class="text-center mt-6">
                <button id="backToMenuFromHelp" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Got it!</button>
            </div>
        </div>

        <!-- Set Word Screen -->
        <div id="setWordScreen" class="hidden screen text-center">
            <h2 id="setWordTitle" class="text-2xl font-bold text-gray-700 dark:text-gray-200 mb-2">Set the Secret Word</h2>
            <p id="setWordSubtitle" class="text-gray-500 dark:text-gray-400 mb-4">Enter a 4-letter word for the other player to guess.</p>
            <div id="setWordMessageArea" class="text-center min-h-10 mb-4 font-medium text-lg hidden items-center justify-center p-2 rounded-lg"></div>
            <div class="flex flex-col sm:flex-row gap-3 max-w-sm mx-auto">
                <input type="password" id="secretWordInput" maxlength="4" placeholder="Enter secret word..."
                       class="flex-grow w-full px-4 py-3 text-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 bg-opacity-50 rounded-lg transition-all duration-300 focus:border-green-500 dark:focus:border-green-400 focus:ring-2 focus:ring-green-500">
                <button id="startGameButton"
                        class="w-full sm:w-auto bg-gradient-to-br from-green-600 to-green-700 text-white font-bold py-3 px-6 rounded-lg hover:from-green-700 hover:to-green-800 focus:outline-none focus:ring-4 focus:ring-green-300 dark:focus:ring-green-800 shadow-lg transition-all">
                    Start Game
                </button>
            </div>
            <button id="backToMenuFromSet" class="mt-4 text-sm font-semibold text-blue-600 dark:text-blue-400 hover:underline">Back to Menu</button>
        </div>
        
        <!-- Main Game Screen -->
        <div id="gameScreen" class="hidden screen">
            <!-- Score Display -->
            <div id="scoreDisplay" class="hidden text-center mb-4 p-3 bg-gray-200 dark:bg-gray-700 bg-opacity-50 rounded-lg">
                <div class="flex justify-between items-center text-lg text-gray-700 dark:text-gray-200">
                    <span id="player1Name" class="font-bold">Player 1</span>
                    <span class="font-bold"><span id="player1Score">0</span> - <span id="player2Score">0</span></span>
                    <span id="player2Name" class="font-bold">Player 2</span>
                </div>
                <p id="scoreToBeatDisplay" class="text-sm text-gray-500 dark:text-gray-400 mt-1 hidden"></p>
                <div id="timerDisplay" class="text-sm text-gray-500 dark:text-gray-400 mt-1 hidden">Time: <span id="timer">0s</span></div>
            </div>
            
            <div class="flex flex-col md:flex-row md:gap-8">
                <!-- Left Panel: Game Controls -->
                <div class="w-full md:w-2/3">
                    <div id="guessControls" class="flex flex-col sm:flex-row gap-3 mb-4">
                        <input type="text" id="guessInput" maxlength="4" placeholder="Enter your guess..."
                               class="flex-grow w-full px-4 py-3 text-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 bg-opacity-50 rounded-lg transition-all duration-300 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-2 focus:ring-blue-500">
                        <button id="guessButton"
                                class="w-full sm:w-auto bg-gradient-to-br from-purple-600 to-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-blue-700 focus:outline-none focus:ring-4 focus:ring-purple-300 dark:focus:ring-purple-800 transform transition-all duration-200 hover:scale-105 shadow-lg">
                            Guess
                        </button>
                    </div>
                    
                    <div id="gameControls" class="flex justify-center gap-4 mb-6">
                        <button id="quitButton"
                                class="bg-gradient-to-br from-red-500 to-red-600 text-white font-bold py-2 px-5 rounded-lg hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-800 transition-all duration-300 shadow-md">
                            Quit & Reveal
                        </button>
                    </div>

                    <div id="messageArea" class="text-center min-h-10 mt-8 mb-4 font-medium text-lg flex items-center justify-center p-2 rounded-lg"></div>

                    <!-- Rematch Request Area -->
                    <div id="rematchRequestArea" class="hidden text-center mt-4 p-4 bg-blue-100 dark:bg-gray-700 bg-opacity-80 rounded-lg">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Right Panel: Guess History -->
                <div class="w-full md:w-1/3 mt-6 md:mt-0">
                    <div id="historyContainer" class="bg-white dark:bg-gray-900 bg-opacity-50 rounded-lg shadow-inner">
                        <div class="grid grid-cols-4 gap-2 text-center font-bold text-gray-600 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 bg-opacity-50 p-2 rounded-t-lg">
                            <div>#</div>
                            <div>Guess</div>
                            <div>Cows üêÆ</div>
                            <div>Bulls üêÉ</div>
                        </div>
                        <div id="guessHistory" class="border-x border-b border-gray-200 dark:border-gray-700 border-opacity-50 rounded-b-lg max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // CrazyGames SDK Integration
        let sdk;
        let gameplayStarted = false;

        async function initializeCrazyGamesSDK() {
            try {
                if (window.CrazyGames && window.CrazyGames.SDK) {
                    sdk = await window.CrazyGames.SDK.getInstance();
                    console.log("CrazyGames SDK initialized successfully");
                    
                    // Set up ad event listeners
                    sdk.addEventListener('adStarted', () => {
                        console.log('Ad started');
                        // Pause game if needed
                    });
                    
                    sdk.addEventListener('adFinished', () => {
                        console.log('Ad finished');
                        // Resume game if needed
                    });
                    
                    sdk.addEventListener('adError', (error) => {
                        console.log('Ad error:', error);
                    });
                    
                    // Initialize the game module
                    if (sdk.game) {
                        console.log("Game module available");
                    }
                } else {
                    console.warn("CrazyGames SDK not available");
                }
            } catch (error) {
                console.error("Failed to initialize CrazyGames SDK:", error);
            }
        }

        function triggerGameplayStart() {
            if (sdk && sdk.game && !gameplayStarted) {
                try {
                    sdk.game.gameplayStart();
                    gameplayStarted = true;
                    console.log("Gameplay started");
                } catch (error) {
                    console.error("Error starting gameplay:", error);
                }
            }
        }

        function triggerGameplayStop() {
            if (sdk && sdk.game && gameplayStarted) {
                try {
                    sdk.game.gameplayStop();
                    gameplayStarted = false;
                    console.log("Gameplay stopped");
                } catch (error) {
                    console.error("Error stopping gameplay:", error);
                }
            }
        }

        function triggerHappyTime() {
            if (sdk && sdk.game) {
                try {
                    sdk.game.happytime();
                    console.log("Happy time triggered");
                } catch (error) {
                    console.error("Error triggering happy time:", error);
                }
            }
        }

        function showAd(type = 'midgame') {
            if (sdk && sdk.ad) {
                try {
                    sdk.ad.requestAd(type);
                    console.log(`Requested ${type} ad`);
                } catch (error) {
                    console.error("Error requesting ad:", error);
                }
            }
        }

        // Word Lists
        const beginnerWords = ['acid', 'also', 'back', 'band', 'bank', 'bare', 'base', 'beam', 'bean', 'bear', 'beat', 'belt', 'bend', 'best', 'bike', 'bird', 'blow', 'blue', 'boat', 'body', 'bold', 'bond', 'bone', 'born', 'both', 'bowl', 'burn', 'cake', 'calm', 'came', 'camp', 'card', 'care', 'case', 'cash', 'cast', 'cave', 'city', 'club', 'coal', 'coat', 'code', 'coin', 'cold', 'come', 'cone', 'copy', 'cord', 'core', 'corn', 'cost', 'dark', 'date', 'dawn', 'deal', 'deck', 'desk', 'dirt', 'dish', 'dock', 'done', 'down', 'drag', 'draw', 'drip', 'drop', 'duck', 'dust', 'earn', 'east', 'easy', 'face', 'fact', 'fade', 'fail', 'fair', 'fake', 'farm', 'fast', 'fear', 'file', 'film', 'find', 'fine', 'fire', 'firm', 'fish', 'five', 'flag', 'flat', 'flow', 'fold', 'font', 'ford', 'fork', 'form', 'four', 'from', 'fuel', 'game', 'gate', 'gave', 'gift', 'give', 'glad', 'glow', 'goal', 'goat', 'gold', 'gone', 'grab', 'gray', 'grid', 'grow', 'gulf', 'hair', 'half', 'hand', 'hang', 'hard', 'harm', 'hate', 'have', 'head', 'heal', 'heap', 'hear', 'heat', 'help', 'herd', 'here', 'hide', 'high', 'hike', 'hint', 'hold', 'hole', 'home', 'hope', 'horn', 'hour', 'hunt', 'hurt', 'idea', 'into', 'iron', 'item', 'join', 'joke', 'jump', 'just', 'kept', 'kind', 'king', 'know', 'lack', 'lady', 'lake', 'lamp', 'land', 'lane', 'last', 'late', 'lawn', 'lead', 'leaf', 'leak', 'lean', 'left', 'lend', 'life', 'lift', 'like', 'limb', 'line', 'link', 'lion', 'list', 'live', 'load', 'loan', 'lock', 'lone', 'long', 'lord', 'lose', 'lost', 'love', 'luck', 'made', 'mail', 'main', 'make', 'male', 'many', 'mark', 'mask', 'mate', 'meal', 'mean', 'meat', 'mend', 'mild', 'mile', 'milk', 'mind', 'mine', 'mist', 'mode', 'mold', 'mole', 'more', 'most', 'move', 'much', 'must', 'nail', 'name', 'near', 'neat', 'neck', 'nest', 'news', 'next', 'nice', 'nine', 'nose', 'note', 'open', 'oral', 'oven', 'over', 'page', 'paid', 'pain', 'pair', 'pale', 'park', 'part', 'past', 'path', 'pave', 'pick', 'pile', 'pine', 'pink', 'pipe', 'plan', 'play', 'plot', 'plug', 'plus', 'poem', 'poet', 'poke', 'pole', 'pond', 'pork', 'port', 'post', 'pure', 'push', 'race', 'rack', 'raft', 'rail', 'rain', 'rake', 'ramp', 'rank', 'rate', 'read', 'real', 'rely', 'rent', 'rest', 'rice', 'rich', 'ride', 'ring', 'rise', 'risk', 'road', 'roam', 'robe', 'rock', 'rode', 'role', 'rope', 'rosy', 'ruin', 'rule', 'rush', 'rust', 'safe', 'said', 'sail', 'sake', 'sale', 'salt', 'same', 'sand', 'sane', 'sang', 'save', 'seat', 'self', 'send', 'sent', 'ship', 'shot', 'show', 'shut', 'sick', 'side', 'sigh', 'sign', 'silk', 'sing', 'sink', 'site', 'size', 'skin', 'skip', 'slow', 'snap', 'snow', 'soak', 'soap', 'soft', 'soil', 'sold', 'sole', 'some', 'song', 'sore', 'sort', 'soul', 'soup', 'sour', 'star', 'stay', 'stem', 'step', 'stop', 'such', 'suit', 'sure', 'surf', 'swim', 'tail', 'take', 'tale', 'talk', 'tame', 'tank', 'tape', 'task', 'team', 'tear', 'tend', 'tent', 'term', 'text', 'than', 'that', 'them', 'then', 'they', 'thin', 'this', 'tide', 'tidy', 'tile', 'time', 'tiny', 'tire', 'tomb', 'tone', 'took', 'tour', 'town', 'trap', 'tray', 'trim', 'trio', 'trip', 'true', 'tube', 'tune', 'turn', 'twin', 'type', 'unit', 'upon', 'used', 'user', 'vain', 'vast', 'vein', 'vent', 'verb', 'very', 'vest', 'view', 'vote', 'wade', 'wait', 'wake', 'walk', 'wand', 'want', 'ward', 'ware', 'warm', 'warn', 'wash', 'wave', 'weak', 'wear', 'went', 'were', 'west', 'what', 'when', 'wide', 'wife', 'wild', 'wind', 'wine', 'wink', 'wipe', 'wire', 'wise', 'wish', 'with', 'woke', 'wolf', 'word', 'wore', 'work', 'worm', 'worn', 'wrap', 'yard', 'yarn', 'yawn', 'year', 'your'];
        const intermediateWords = ['aged', 'aunt', 'axis', 'barn', 'bath', 'bind', 'bite', 'blur', 'boil', 'bolt', 'bomb', 'bony', 'brag', 'brew', 'brim', 'buck', 'bulk', 'bury', 'bush', 'bust', 'busy', 'byte', 'cane', 'cape', 'chat', 'chef', 'chew', 'chin', 'chip', 'chop', 'cite', 'clam', 'clan', 'clap', 'claw', 'clay', 'clip', 'clue', 'colt', 'conk', 'cork', 'cozy', 'crab', 'cram', 'crew', 'crib', 'crow', 'cube', 'cult', 'curb', 'cure', 'curl', 'curt', 'cute', 'damp', 'dare', 'darn', 'dart', 'dash', 'deaf', 'debt', 'deny', 'dent', 'dial', 'dice', 'diet', 'dime', 'dine', 'disc', 'dive', 'does', 'dole', 'dome', 'dose', 'dote', 'drab', 'dram', 'drew', 'drug', 'drum', 'dual', 'duct', 'duel', 'duet', 'duke', 'duly', 'dumb', 'dump', 'dune', 'dunk', 'dusk', 'duty', 'echo', 'edge', 'edit', 'else', 'envy', 'epic', 'even', 'evil', 'exam', 'exit', 'fang', 'fate', 'fawn', 'feat', 'feud', 'fink', 'fist', 'flak', 'flan', 'flap', 'flaw', 'flax', 'flea', 'fled', 'flew', 'flex', 'flip', 'flog', 'flux', 'foal', 'foam', 'foci', 'foil', 'folk', 'foul', 'fowl', 'frag', 'fray', 'fume', 'fund', 'funk', 'fury', 'fuse', 'gain', 'gaze', 'gear', 'gnaw', 'grad', 'gram', 'grim', 'grin', 'grip', 'grub', 'gunk', 'guru', 'gust', 'guts', 'hack', 'hail', 'halo', 'halt', 'hark', 'harp', 'haul', 'hawk', 'haze', 'hazy', 'heir', 'hemp', 'herb', 'hero', 'hoax', 'homy', 'honk', 'hose', 'host', 'huge', 'hulk', 'hump', 'hung', 'hurl', 'hush', 'husk', 'hymn', 'hype', 'icon', 'idle', 'idol', 'inch', 'info', 'jail', 'jolt', 'junk', 'jury', 'keys', 'kick', 'kilo', 'kite', 'kiwi', 'knob', 'knot', 'lace', 'laid', 'lair', 'lamb', 'lame', 'lank', 'lard', 'lark', 'lava', 'lazy', 'lens', 'lent', 'lobe', 'loft', 'loin', 'lore', 'lout', 'lows', 'lump', 'lung', 'lure', 'lurk', 'lush', 'lust', 'lynx', 'lyre', 'maid', 'malt', 'mane', 'maps', 'mare', 'mars', 'mast', 'maul', 'maze', 'mead', 'meld', 'melt', 'memo', 'meow', 'mesh', 'mice', 'mime', 'mink', 'mint', 'mire', 'mite', 'moan', 'moat', 'mock', 'molt', 'monk', 'moth', 'muck', 'mule', 'murk', 'muse', 'mush', 'mute', 'myth', 'navy', 'nerd', 'node', 'nope', 'numb', 'oath', 'obey', 'onyx', 'opal', 'ouch', 'oust', 'oval', 'pact', 'pail', 'palm', 'pane', 'pant', 'pawn', 'peak', 'pear', 'pelt', 'perk', 'pest', 'pike', 'pint', 'pity', 'plea', 'plod', 'plop', 'plow', 'plum', 'pram', 'prey', 'prod', 'prom', 'prop', 'prow', 'puck', 'puke', 'pulp', 'puma', 'pump', 'punk', 'punt', 'puny', 'putz', 'quip', 'raft', 'rage', 'raid', 'rand', 'rant', 'rapt', 'rare', 'rash', 'rave', 'raze', 'ream', 'reap', 'redo', 'rife', 'rift', 'rime', 'rink', 'roan', 'roar', 'romp', 'rote', 'rout', 'rove', 'rube', 'ruby', 'rude', 'rump', 'rune', 'rung', 'runt', 'ruse', 'rusk', 'sack', 'scam', 'scat', 'scow', 'scum', 'sect', 'serf', 'shag', 'sham', 'shed', 'shim', 'shod', 'shun', 'silo', 'skew', 'skid', 'skim', 'slag', 'slat', 'slay', 'slew', 'slit', 'slob', 'slog', 'slug', 'slum', 'slur', 'smog', 'smug', 'snag', 'snip', 'snit', 'snob', 'snot', 'snub', 'snug', 'sock', 'soda', 'sofa', 'solo', 'spam', 'span', 'spar', 'spat', 'spay', 'spec', 'spin', 'spit', 'spot', 'spud', 'spur', 'stab', 'stag', 'stew', 'stir', 'stow', 'stub', 'stud', 'stun', 'sued', 'suet', 'sumo', 'sung', 'sunk', 'swab', 'swag', 'swam', 'swan', 'swap', 'swat', 'sway', 'swig', 'swum', 'taco', 'tact', 'tamp', 'taps', 'tare', 'tarp', 'taxi', 'tech', 'thaw', 'thud', 'thug', 'thus', 'tick', 'tier', 'tine', 'ting', 'tint', 'toad', 'tong', 'tony', 'torn', 'tout', 'toys', 'tram', 'trod', 'trot', 'tuck', 'tuna', 'turf', 'tusk', 'twig', 'twit', 'typo', 'ugly', 'unto', 'vamp', 'vane', 'vary', 'veal', 'vend', 'veto', 'vial', 'vibe', 'vice', 'vine', 'visa', 'void', 'volt', 'waif', 'warp', 'wart', 'wary', 'wasp', 'wavy', 'webs', 'weld', 'welt', 'wept', 'whet', 'whey', 'whim', 'whip', 'whit', 'whom', 'wick', 'wile', 'wilt', 'wimp', 'wino', 'wisp', 'wove', 'wren', 'yacht', 'yank', 'yeti', 'yoke', 'yolk', 'yule', 'zany', 'zero', 'zest', 'zinc', 'zing', 'zone', 'zonk'];
        const proWords = ['quiz', 'jury', 'jump', 'joke', 'jolt', 'junk', 'kiwi', 'knob', 'lynx', 'myth', 'onyx', 'pulp', 'pump', 'quad', 'quip', 'quit', 'quiz', 'yacht', 'yank', 'yeti', 'yoke', 'yolk', 'zany', 'zero', 'zest', 'zinc', 'zing', 'zone', 'zonk', 'flux', 'jinx', 'hymn', 'hype', 'trek', 'whiz', 'foxy', 'jock', 'jowl', 'judo'];

        // DOM Elements
        const allScreens = document.querySelectorAll('.screen');
        const startScreen = document.getElementById('startScreen');
        const modeSelectionScreen = document.getElementById('modeSelectionScreen');
        const difficultySelectionScreen = document.getElementById('difficultySelectionScreen');
        const howToPlayScreen = document.getElementById('howToPlayScreen');
        const setWordScreen = document.getElementById('setWordScreen');
        const gameScreen = document.getElementById('gameScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const timerDisplay = document.getElementById('timerDisplay');
        const messageArea = document.getElementById('messageArea');
        const mainMessageArea = document.getElementById('mainMessageArea');
        const guessHistory = document.getElementById('guessHistory');
        const rematchRequestArea = document.getElementById('rematchRequestArea');

        // Game State
        let secretWord = '';
        let gameOver = false;
        let gameMode = null;
        let attemptCount = 0;
        let localGuessHistory = [];
        let timerInterval;
        let player1LocalScore = 0, player2LocalScore = 0, localGamesPlayed = 0, currentPlayerSetter = 1;
        let player1LocalName = 'Player 1', player2LocalName = 'Player 2';
        let scoreToBeat = 0;
        let roundLost = false;

        // Audio
        let soundsReady = false;
        const sounds = {};

        // Initialize audio context on first user interaction
        document.body.addEventListener('click', async () => {
            if (!soundsReady) {
                try {
                    await Tone.start();
                    console.log('Audio context started');
                    
                    // Initialize sound effects
                    sounds.click = new Tone.Synth({ 
                        oscillator: { type: 'sine' }, 
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 } 
                    }).toDestination();
                    
                    sounds.ding = new Tone.MetalSynth({ 
                        frequency: 300, 
                        envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
                        harmonicity: 3.1, 
                        modulationIndex: 16, 
                        resonance: 4000, 
                        octaves: 1.5 
                    }).toDestination();
                    
                    sounds.win = new Tone.PolySynth(Tone.Synth, { 
                        oscillator: { type: "sine" }, 
                        envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } 
                    }).toDestination();
                    
                    sounds.lose = new Tone.Synth({ 
                        oscillator: { type: 'triangle' }, 
                        envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.1 } 
                    }).toDestination();
                    
                    soundsReady = true;
                } catch (error) {
                    console.error('Audio initialization failed:', error);
                }
            }
        }, { once: true });

        function playSound(sound) {
            if (!soundsReady || Tone.Destination.mute) return;
            try {
                switch(sound) {
                    case 'click':
                        sounds.click?.triggerAttackRelease('C5', '8n');
                        break;
                    case 'ding':
                        sounds.ding?.triggerAttackRelease('C5', '8n');
                        break;
                    case 'win':
                        sounds.win?.triggerAttackRelease(['C5', 'E5', 'G5'], '8n');
                        break;
                    case 'lose':
                        sounds.lose?.triggerAttackRelease('C3', '4n');
                        break;
                }
            } catch (error) {
                console.error('Sound playback failed:', error);
            }
        }

        // Utility Functions
        function showScreen(screenToShow) {
            allScreens.forEach(screen => screen.classList.add('hidden'));
            screenToShow.classList.remove('hidden');
            screenToShow.classList.add('screen');
        }

        function showMessage(text, type = 'info', area = messageArea) {
            area.textContent = text;
            area.className = `text-center min-h-10 mt-4 mb-4 font-medium text-lg flex items-center justify-center p-2 rounded-lg message-${type}`;
            area.classList.remove('hidden');
        }

        function showMainMessage(text, type = 'info') {
            showMessage(text, type, mainMessageArea);
            setTimeout(() => mainMessageArea.classList.add('hidden'), 3000);
        }

        function hasConsecutiveDuplicates(word) {
            for (let i = 0; i < word.length - 1; i++) {
                if (word[i] === word[i+1]) return true;
            }
            return false;
        }

        function getSecretWord(difficulty) {
            const wordList = {
                beginner: beginnerWords,
                intermediate: intermediateWords,
                pro: proWords
            }[difficulty];
            return wordList[Math.floor(Math.random() * wordList.length)];
        }

        function validateWord(word) {
            if (word.length !== 4) return "Word must be 4 letters long.";
            if (!/^[a-z]+$/.test(word)) return "Word must contain only letters.";
            if (hasConsecutiveDuplicates(word)) {
                return "Word cannot have consecutive identical letters (e.g., 'tree').";
            }
            return null;
        }

        function initializeGameUI(resetSecret = true, difficulty = 'beginner') {
            gameOver = false;
            roundLost = false;
            attemptCount = 0;
            guessHistory.innerHTML = '';
            localGuessHistory = [];
            messageArea.classList.add('hidden');
            rematchRequestArea.classList.add('hidden');
            document.getElementById('gameControls').classList.remove('hidden');
            document.getElementById('guessControls').classList.remove('hidden');
            document.getElementById('guessInput').value = '';
            document.getElementById('secretWordInput').value = '';
            document.getElementById('guessInput').disabled = false;
            document.getElementById('guessButton').disabled = false;
            
            scoreDisplay.classList.add('hidden');
            document.getElementById('scoreToBeatDisplay').classList.add('hidden');
            timerDisplay.classList.add('hidden');
            if(timerInterval) clearInterval(timerInterval);
            
            if (resetSecret && gameMode === 'single') {
                secretWord = getSecretWord(difficulty);
                startTimer();
            }
            showScreen(gameScreen);
            document.getElementById('guessInput').focus();
        }

        function startTimer() {
            let seconds = 0;
            timerDisplay.classList.remove('hidden');
            document.getElementById('timer').textContent = '0s';
            timerInterval = setInterval(() => {
                seconds++;
                document.getElementById('timer').textContent = `${seconds}s`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateHistory(guesses) {
            guessHistory.innerHTML = '';
            guesses.forEach((item, index) => {
                const { guess, cows, bulls } = item;
                const historyItem = document.createElement('div');
                historyItem.className = 'grid grid-cols-4 gap-2 text-center p-2 text-gray-800 dark:text-gray-200 history-row';
                historyItem.innerHTML = `
                    <div class="font-bold text-lg text-gray-500 dark:text-gray-400">${index + 1}</div>
                    <div class="font-mono text-lg tracking-widest">${guess.toUpperCase()}</div>
                    <div class="font-bold text-lg">${cows}</div>
                    <div class="font-bold text-lg">${bulls}</div>`;
                guessHistory.appendChild(historyItem);
            });
            if(guessHistory.lastChild) {
                guessHistory.lastChild.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function triggerConfetti() {
            const container = document.getElementById('confetti-container');
            const colors = ['#a855f7', '#6366f1', '#10b981', '#f59e0b', '#ef4444'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animation = `fall ${2 + Math.random() * 2}s ${Math.random()}s linear forwards`;
                container.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        }

        function goToMainMenu() {
            triggerGameplayStop();
            showAd('midgame');
            showScreen(modeSelectionScreen);
        }

        // Local 2-Player Logic
        function startLocalMatch() {
            gameMode = 'twoPlayerLocal';
            player1LocalScore = 0;
            player2LocalScore = 0;
            localGamesPlayed = 0;
            currentPlayerSetter = 1;
            player1LocalName = 'Player 1';
            player2LocalName = 'Player 2';
            scoreToBeat = 0;
            promptSetLocalWord();
        }

        function promptSetLocalWord() {
            document.getElementById('setWordTitle').textContent = `${currentPlayerSetter === 1 ? player1LocalName : player2LocalName}: Set the Word`;
            document.getElementById('setWordSubtitle').textContent = `${currentPlayerSetter === 1 ? player2LocalName : player1LocalName}, look away!`;
            document.getElementById('backToMenuFromSet').classList.toggle('hidden', localGamesPlayed > 0 || scoreToBeat > 0);
            showScreen(setWordScreen);
        }

        function startLocalGame() {
            secretWord = document.getElementById('secretWordInput').value.toLowerCase();
            const validationError = validateWord(secretWord);
            if (validationError) { 
                showMessage(validationError, 'error', document.getElementById('setWordMessageArea')); 
                return; 
            }
            initializeGameUI(false);
            updateLocalScoreDisplay();
        }

        function updateLocalScoreDisplay() {
            document.getElementById('player1Name').textContent = player1LocalName;
            document.getElementById('player2Name').textContent = player2LocalName;
            document.getElementById('player1Score').textContent = player1LocalScore;
            document.getElementById('player2Score').textContent = player2LocalScore;
            scoreDisplay.classList.remove('hidden');

            if (scoreToBeat > 0) {
                document.getElementById('scoreToBeatDisplay').textContent = `Score to Beat: ${scoreToBeat} attempts`;
                document.getElementById('scoreToBeatDisplay').classList.remove('hidden');
            }
        }

        function startLocalRematch() {
            currentPlayerSetter = currentPlayerSetter === 1 ? 2 : 1;
            promptSetLocalWord();
        }

        // Event Listeners
        function setupEventListeners() {
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                playSound('click');
                document.documentElement.classList.toggle('dark');
                const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                try {
                    localStorage.setItem('theme', theme);
                } catch (e) {
                    console.warn('localStorage not available');
                }
                updateThemeIcons();
            });

            // Mute toggle
            document.getElementById('muteButton').addEventListener('click', () => {
                if (Tone.Destination) {
                    Tone.Destination.mute = !Tone.Destination.mute;
                    try {
                        localStorage.setItem('muted', Tone.Destination.mute);
                    } catch (e) {
                        console.warn('localStorage not available');
                    }
                    updateMuteIcons();
                }
            });

            // Start button
            document.getElementById('startButton').addEventListener('click', () => {
                triggerGameplayStart();
                playSound('click');
                showScreen(modeSelectionScreen);
            });

            // Mode selection
            document.getElementById('singlePlayerButton').addEventListener('click', () => { 
                gameMode = 'single'; 
                playSound('click'); 
                showScreen(difficultySelectionScreen); 
            });

            document.getElementById('twoPlayerButton').addEventListener('click', () => { 
                playSound('click'); 
                startLocalMatch(); 
            });

            document.getElementById('howToPlayButton').addEventListener('click', () => { 
                playSound('click'); 
                showScreen(howToPlayScreen); 
            });

            // Back buttons
            document.getElementById('backToMenuFromDiff').addEventListener('click', () => { 
                playSound('click'); 
                goToMainMenu(); 
            });

            document.getElementById('backToMenuFromHelp').addEventListener('click', () => { 
                playSound('click'); 
                goToMainMenu(); 
            });

            document.getElementById('backToMenuFromSet').addEventListener('click', () => { 
                playSound('click'); 
                goToMainMenu(); 
            });

            // Difficulty selection
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    playSound('click');
                    initializeGameUI(true, e.target.dataset.difficulty);
                });
            });

            // Game controls
            document.getElementById('startGameButton').addEventListener('click', () => {
                playSound('click');
                if (gameMode === 'twoPlayerLocal') {
                    startLocalGame();
                }
            });

            document.getElementById('guessButton').addEventListener('click', handleGuess);

            document.getElementById('guessInput').addEventListener('keyup', (e) => { 
                if (e.key === 'Enter') {
                    document.getElementById('guessButton').click(); 
                }
            });

            document.getElementById('quitButton').addEventListener('click', () => {
                playSound('click');
                handleQuit();
            });
        }

        function handleGuess() {
            if (gameOver && !roundLost) return;
            
            const guess = document.getElementById('guessInput').value.toLowerCase();
            const validationError = validateWord(guess);
            if (validationError) { 
                showMessage(validationError, 'error'); 
                return; 
            }
            
            attemptCount++; 
            let cows = 0; 
            let bulls = 0;
            const secretLetters = secretWord.split(''); 
            const guessLetters = guess.split('');
            
            // Count cows (correct position)
            for (let i = 0; i < 4; i++) { 
                if (guessLetters[i] === secretLetters[i]) { 
                    cows++; 
                    secretLetters[i] = null; 
                    guessLetters[i] = null; 
                } 
            }
            
            // Count bulls (wrong position)
            for(let i = 0; i < 4; i++){ 
                if(guessLetters[i] === null) continue; 
                const bullIndex = secretLetters.indexOf(guessLetters[i]); 
                if(bullIndex !== -1) { 
                    bulls++; 
                    secretLetters[bullIndex] = null; 
                } 
            }
            
            if (cows > 0 || bulls > 0) playSound('ding');
            
            const newGuess = { guess, cows, bulls };
            localGuessHistory.push(newGuess);
            updateHistory(localGuessHistory);
            
            // Check if player lost in 2-player mode
            if (gameMode === 'twoPlayerLocal' && scoreToBeat > 0 && attemptCount > scoreToBeat && !roundLost) {
                roundLost = true;
                const guesserName = currentPlayerSetter === 1 ? player2LocalName : player1LocalName;
                const setterName = currentPlayerSetter === 1 ? player1LocalName : player2LocalName;
                showMessage(`${guesserName}, you failed to beat the score! ${setterName} wins the point. You can still guess the word.`, 'info');
                playSound('lose');
                
                (setterName === player1LocalName) ? player1LocalScore++ : player2LocalScore++;
                updateLocalScoreDisplay();
            }

            // Check if word is guessed
            if (cows === 4) {
                triggerHappyTime();
                gameOver = true;
                document.getElementById('guessControls').classList.add('hidden');
                document.getElementById('gameControls').classList.add('hidden');
                
                if (gameMode === 'single') {
                    stopTimer();
                    showMessage(`You guessed it in ${attemptCount} attempts! Time: ${document.getElementById('timer').textContent}`, 'success');
                    playSound('win');
                    triggerConfetti();
                    showRematchOptions('single');
                } else if (gameMode === 'twoPlayerLocal') {
                    handleLocalGameEnd();
                }
            } else if (!roundLost) { 
                messageArea.classList.add('hidden'); 
            }
            
            document.getElementById('guessInput').value = '';
            document.getElementById('guessInput').focus();
        }

        function handleLocalGameEnd() {
            if (roundLost) { 
                showMessage(`You found the word! It was "${secretWord}".`, 'info');
                showRematchOptions('local');
                return;
            }

            if (scoreToBeat === 0) { // First round of a match
                scoreToBeat = attemptCount;
                const guesserName = currentPlayerSetter === 1 ? player2LocalName : player1LocalName;
                const setterName = currentPlayerSetter === 1 ? player1LocalName : player2LocalName;
                showMessage(`${guesserName} guessed it in ${attemptCount} attempts! ${setterName}, you must beat this score.`, 'success');
                playSound('win');
                triggerConfetti();
                showRematchOptions('nextRound');
            } else { // Second round of a match, point is decided
                localGamesPlayed++;
                let messageText;

                if (attemptCount < scoreToBeat) {
                    const winnerName = currentPlayerSetter === 1 ? player2LocalName : player1LocalName;
                    (winnerName === player1LocalName) ? player1LocalScore++ : player2LocalScore++;
                    messageText = `${winnerName} wins the point! The word was "${secretWord}".`;
                    playSound('win');
                    triggerConfetti();
                } else if (attemptCount === scoreToBeat) {
                    player1LocalScore++;
                    player2LocalScore++;
                    messageText = `It's a tie! Both players get a point. The word was "${secretWord}".`;
                    playSound('win');
                    triggerConfetti();
                } else { 
                    const winnerName = currentPlayerSetter === 1 ? player1LocalName : player2LocalName;
                    (winnerName === player1LocalName) ? player1LocalScore++ : player2LocalScore++;
                    messageText = `${winnerName} wins the point! The word was "${secretWord}".`;
                    playSound('win');
                    triggerConfetti();
                }
                
                updateLocalScoreDisplay(); 
                showMessage(messageText, 'success');
                scoreToBeat = 0; 
                showRematchOptions('local');
            }
        }

        function showRematchOptions(type) {
            let content = '';
            if (type === 'single') {
                content = `<div class="flex justify-center gap-4">
                    <button id="playAgainSingle" class="bg-gradient-to-br from-blue-600 to-sky-600 text-white font-bold py-2 px-5 rounded-lg">Play Again</button>
                    <button id="mainMenuBtn" class="bg-gray-600 text-white font-bold py-2 px-5 rounded-lg">Main Menu</button>
                </div>`;
            } else if (type === 'nextRound') {
                content = `<div class="flex justify-center gap-4">
                    <button id="nextRoundLocal" class="bg-gradient-to-br from-blue-600 to-sky-600 text-white font-bold py-2 px-5 rounded-lg">Next Round</button>
                </div>`;
            } else if (type === 'local') {
                content = `<div class="flex justify-center gap-4">
                    <button id="playAgainLocal" class="bg-gradient-to-br from-blue-600 to-sky-600 text-white font-bold py-2 px-5 rounded-lg">Play Again</button>
                    <button id="endMatchLocal" class="bg-gradient-to-br from-red-500 to-red-600 text-white font-bold py-2 px-5 rounded-lg">End Match</button>
                </div>`;
            }

            rematchRequestArea.innerHTML = content;
            rematchRequestArea.classList.remove('hidden');

            // Add event listeners
            const playAgainSingle = document.getElementById('playAgainSingle');
            const mainMenuBtn = document.getElementById('mainMenuBtn');
            const nextRoundLocal = document.getElementById('nextRoundLocal');
            const playAgainLocal = document.getElementById('playAgainLocal');
            const endMatchLocal = document.getElementById('endMatchLocal');

            if (playAgainSingle) playAgainSingle.onclick = () => { playSound('click'); showScreen(difficultySelectionScreen); };
            if (mainMenuBtn) mainMenuBtn.onclick = () => { playSound('click'); goToMainMenu(); };
            if (nextRoundLocal) nextRoundLocal.onclick = () => { playSound('click'); startLocalRematch(); };
            if (playAgainLocal) playAgainLocal.onclick = () => { playSound('click'); startLocalRematch(); };
            if (endMatchLocal) endMatchLocal.onclick = () => { playSound('click'); goToMainMenu(); };
        }

        function handleQuit() {
            gameOver = true;
            document.getElementById('guessControls').classList.add('hidden');
            document.getElementById('gameControls').classList.add('hidden');
            
            if (gameMode === 'single') {
                stopTimer();
                showMessage(`The word was "${secretWord}". Better luck next time!`, 'info');
                playSound('lose');
                showRematchOptions('single');
            } else if (gameMode === 'twoPlayerLocal') {
                const setterName = currentPlayerSetter === 1 ? player1LocalName : player2LocalName;
                showMessage(`The word was "${secretWord}". ${setterName} wins the point!`, 'info');
                playSound('lose');

                if(scoreToBeat > 0 || localGamesPlayed === 0) {
                    if (currentPlayerSetter === 1) {
                        player1LocalScore++;
                    } else {
                        player2LocalScore++;
                    }
                    localGamesPlayed++;
                }
                scoreToBeat = 0; 
                updateLocalScoreDisplay();
                showRematchOptions('local');
            }
        }

        function updateThemeIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('theme-icon-light').classList.toggle('hidden', isDark);
            document.getElementById('theme-icon-dark').classList.toggle('hidden', !isDark);
        }

        function updateMuteIcons() {
            const isMuted = Tone.Destination?.mute || false;
            document.getElementById('unmuteIcon').classList.toggle('hidden', isMuted);
            document.getElementById('muteIcon').classList.toggle('hidden', !isMuted);
        }

        // Initialize the game
        async function initializeGame() {
            // Initialize CrazyGames SDK
            await initializeCrazyGamesSDK();

            // Set initial theme
            try {
                const savedTheme = localStorage.getItem('theme');
                const savedMute = localStorage.getItem('muted') === 'true';
                
                if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                }
                
                if (Tone.Destination) {
                    Tone.Destination.mute = savedMute;
                }
            } catch (e) {
                console.warn('localStorage not available, using defaults');
            }

            updateThemeIcons();
            updateMuteIcons();
            setupEventListeners();
            showScreen(startScreen);
        }

        // Start the game when page loads
        window.addEventListener('load', initializeGame);
    </script>
</body>
</html>  
